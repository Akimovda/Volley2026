# Authentication & Identity — Volley

## 1. Цели авторизации

Проект Volley использует **мульти-провайдерную авторизацию** с возможностью
объединения (привязки) аккаунтов.

Поддерживаемые способы входа:
- Telegram Login (основной)
- VK ID (альтернативный)
- Passkey (планируется)

Один пользователь = одна учетная запись в системе,
но может иметь несколько способов входа.

---

## 2. Основная модель идентификации

### Ключевые поля пользователя:
- telegram_id — основной внешний идентификатор
- vk_id — альтернативный внешний идентификатор
- email — служебный (может быть fake)
- phone — основной контакт
- first_name
- last_name
- patronymic (админ-only)
- classic_level / beach_level — уровни игрока

### Отображение пользователя:
- `Фамилия + Имя`, если заполнены
- иначе — `telegram_username`

---

## 3. Telegram Login (основной)

### Используем:
- Telegram Login Widget
- Проверка hash по bot_token
- Защита от replay-атак (auth_date ≤ 24 часа)

### Принципы:
- telegram_username **НЕ используется как имя пользователя**
- email создаётся служебный

### Сценарии:

#### 3.1 Пользователь уже авторизован
→ Telegram **привязывается** к текущему аккаунту  
→ Проверка, что telegram_id не привязан к другому пользователю

#### 3.2 Пользователь не авторизован
→ Поиск пользователя:
- по telegram_id
- либо по email

→ Если не найден — создаётся новый пользователь  
→ После входа:
- redirect `/events`
- логика заполнения профиля **не выполняется при логине**

---

## 4. VK ID Login

Используется **VK ID (OAuth 2.1 + PKCE)**.

### Храним:
- vk_id (уникальный)
- email от VK (если предоставлен)

### Сценарии:
- вход по VK
- привязка VK к существующему аккаунту
- защита от привязки одного vk_id к разным пользователям

---

## 5. Проверка профиля (ВАЖНО)

Проверка заполненности профиля **НЕ выполняется при логине**.

Она выполняется:
- **при попытке записи на мероприятие**

Если данные не заполнены:
→ redirect `/profile/complete?required=...&event_id=...`

Поддерживается:
- новый формат `required=phone,classic_level,...`
- legacy формат `section=personal|classic|beach`

---

## 6. Анкета игрока

Дополнительная анкета:
- first_name / last_name
- phone
- classic_level
- beach_level

Реализована отдельным POST:
`POST /profile/extra`

После сохранения:
- повторно проверяются требования мероприятия
- при успехе происходит **автозапись**
- пользователь получает flash-сообщение

---

## 7. Merge аккаунтов (план)

### Возможные дубли:
- Telegram
- VK
- Email (в будущем)

### Критерии поиска:
1. phone
2. ФИО

### Правила:
- основной аккаунт сохраняется
- дубликаты удаляются
- внешние ID переносятся

---

## 8. Passkey (WebAuthn) — план

Passkey добавляется как **дополнительный способ входа**  
и не создаёт нового пользователя.

---

## 9. Безопасность

- Все внешние ID уникальны
- Один Telegram / VK = один пользователь
- Merge выполняется только явно
- Все sensitive-операции логируются

---

## 10. Текущее состояние

✔ Telegram Login — готов  
✔ VK ID Login — готов  
✔ Профиль / анкета — готово  
✔ Проверка требований мероприятий — готово  
✔ Автозапись — готово  
⏳ Merge UI — в планах  
⏳ Passkey — в планах
## auth_provider в сессии
После успешного логина/привязки мы пишем:
- telegram -> session(['auth_provider' => 'telegram'])
- vk -> session(['auth_provider' => 'vk'])
Это нужно для UX на /user/profile (показываем кнопку привязки только второго провайдера).
